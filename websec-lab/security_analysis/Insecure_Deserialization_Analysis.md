# Insecure Deserialization 분석 보고서

## 1. Insecure Deserialization 이란?

**데이터를 코드로 바꾸는 위험한 마법**

- **정의:** 애플리케이션이 신뢰할 수 없는 소스(사용자 입력, 쿠키, API 응답 등)로부터 받은 직렬화된 데이터를 적절한 검증 없이 역직렬화할 때 발생하는 취약점입니다.
- **원리:** 직렬화는 객체를 바이트 스트림으로 변환하는 과정이고, 역직렬화는 이 바이트 스트림을 다시 메모리상의 객체로 복원하는 과정입니다. 공격자는 악의적으로 조작된 직렬화된 데이터를 전송하여, 역직렬화 과정에서 애플리케이션이 예상치 못한 동작을 수행하도록 유도합니다.
- **영향:**
    - **임의 코드 실행 (RCE):** 가장 심각한 결과로, 공격자가 서버에서 원하는 코드를 실행할 수 있습니다.
    - **서비스 거부 (DoS):** 과도한 리소스 사용을 유발하여 서버를 마비시킵니다.
    - **인증 우회 및 권한 상승:** 객체의 속성을 조작하여 인증을 우회하거나 관리자 권한을 획득합니다.

---

## 2. 취약한 코드 분석 (PHP 예시)

**문제의 핵심: 신뢰할 수 없는 사용자 입력 역직렬화**

```php
class UserProfile {
    public $username;
    public $isAdmin;
}

// 취약한 코드
// 애플리케이션은 사용자 제어 가능한 쿠키에서 직렬화된 데이터를 가져와 역직렬화합니다.
$serialized_data = $_COOKIE['user_profile'];
$user_profile = unserialize($serialized_data);

if ($user_profile->isAdmin) {
    // 관리자 권한 부여
}
```

**핵심 문제점:** 외부에서 들어오는 직렬화된 데이터는 언제나 조작될 수 있다는 점을 간과하고, 이를 그대로 역직렬화하여 사용하는 것입니다.

---

## 3. 공격 시나리오: 원격 코드 실행 (PHP)

**공격 목표:** 서버에서 임의의 명령어 실행하기

**공격용 악성 페이로드 (간략화된 예시):**

`O:15:"VulnerableClass":1:{s:7:"command";s:14:"rm -rf / --help";}`

**공격 과정:**
1.  공격자는 서버에 존재하는 특정 클래스(`VulnerableClass`)가 역직렬화 과정에서 자동으로 호출되는 '매직 메소드'(`__wakeup()`, `__destruct()` 등)를 가지고 있으며, 이 메소드들이 위험한 작업(예: `system()` 함수 호출)을 수행한다는 것을 파악합니다.
2.  공격자는 `VulnerableClass` 객체를 나타내는 직렬화된 문자열을 조작하여, `command` 속성에 `rm -rf /`와 같은 악성 명령어를 삽입합니다.
3.  애플리케이션이 이 악성 직렬화 문자열을 `unserialize()` 함수로 역직렬화하면, `VulnerableClass` 객체가 생성됩니다.
4.  이 과정에서 `__wakeup()` 또는 `__destruct()`와 같은 매직 메소드가 자동으로 호출되고, 공격자가 주입한 명령어가 서버에서 실행됩니다.

---

## 4. 해결책: 신뢰할 수 없는 데이터 역직렬화 금지

**가장 안전한 방법: 역직렬화가 꼭 필요하다면 안전하게 수행하기**

1.  **역직렬화 사용 최소화:** 가장 좋은 방어는 신뢰할 수 없는 소스에서 받은 데이터를 역직렬화하지 않는 것입니다.
2.  **안전한 데이터 형식 사용:** JSON이나 XML과 같은 텍스트 기반의 데이터 교환 형식을 선호합니다. 이들은 일반적으로 이진 직렬화 형식보다 안전합니다.
3.  **화이트리스트 기반 역직렬화:** 역직렬화가 불가피하다면, 역직렬화할 수 있는 클래스의 종류를 엄격하게 제한하는 화이트리스트를 구현합니다.

    ```php
    // PHP 7.0 이상에서 화이트리스트를 이용한 역직렬화 예시
    // 'UserProfile' 클래스만 역직렬화 허용
    $options = ['allowed_classes' => ['UserProfile']];
    $user_profile = unserialize($serialized_data, $options);
    ```

**작동 원리:** 허용된 클래스만 역직렬화하도록 제한함으로써, 공격자가 위험한 클래스의 객체를 주입하여 임의 코드 실행을 유발하는 것을 방지합니다.

---

## 5. 안전하지 않은 역직렬화 방어 전략

1.  **신뢰할 수 없는 데이터 역직렬화 금지 (가장 중요):** 외부에서 들어오는 데이터는 항상 조작될 수 있다는 전제하에, 이를 역직렬화하지 않는 것이 최선입니다.
2.  **엄격한 화이트리스트 구현:** 역직렬화가 필요하다면, 미리 정의된 안전한 클래스 목록에 있는 객체만 역직렬화하도록 허용하고, 그 외의 모든 클래스는 거부합니다.
3.  **안전한 직렬화 형식 사용:** 이진 직렬화 형식 대신 JSON이나 XML과 같은 텍스트 기반의 안전한 데이터 교환 형식을 사용합니다.
4.  **데이터 무결성 검증:** 역직렬화하기 전에 데이터의 무결성과 진위성을 확인하기 위해 HMAC(Hash-based Message Authentication Code)나 디지털 서명을 사용합니다.
5.  **모니터링 및 로깅:** 역직렬화 시도에 대한 비정상적인 활동을 모니터링하고, 모든 오류를 상세히 로깅하여 공격 시도를 탐지합니다.
