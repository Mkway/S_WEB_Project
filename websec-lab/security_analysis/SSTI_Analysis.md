# SSTI (Server-Side Template Injection) 분석 보고서

## 1. SSTI 란?

**사용자 입력이 서버 사이드 코드가 될 때**

- **SSTI란?** Server-Side Template Injection의 약자로, 공격자가 웹 애플리케이션의 템플릿에 악의적인 코드를 주입하여, 서버 측에서 해당 코드가 실행되도록 만드는 공격 기법입니다.
- **원리:** 웹 애플리케이션이 사용자 입력값을 데이터로써 템플릿에 전달하는 대신, 사용자 입력값을 템플릿 자체의 일부로 사용하여 동적으로 렌더링할 때 발생합니다.
- **영향:**
    - **원격 코드 실행 (RCE):** 공격자가 서버의 제어권을 완전히 탈취할 수 있는 가장 심각한 결과를 초래합니다.
    - **민감 정보 유출:** 서버의 환경 변수, 설정 파일, 다른 사용자의 데이터 등을 탈취할 수 있습니다.
    - **파일 시스템 접근:** 서버의 파일을 읽거나, 쓰거나, 삭제할 수 있습니다.

---

## 2. 취약한 코드 분석 (Twig 엔진 예시)

**문제의 핵심: 사용자 입력을 템플릿 자체로 사용하는 것**

```php
// 사용자가 URL을 통해 입력한 이름
$name = $_GET['name'];

// 취약한 코드
// 사용자 입력을 템플릿 문자열의 일부로 사용합니다.
$template = $twig->createTemplate("Hello " . $name);
echo $template->render([]);
```

**안전한 코드:**

```php
// 템플릿은 미리 고정되어 있습니다.
$template = $twig->createTemplate("Hello {{ name }}");

// 사용자 입력은 오직 데이터(변수)로만 전달됩니다.
echo $template->render(['name' => $name]);
```

**핵심 문제점:** 템플릿 코드와 사용자 데이터를 명확히 분리하지 않은 것이 문제입니다. 사용자 입력은 언제나 '데이터'로 취급해야 하며, '코드'의 일부가 되어서는 안 됩니다.

---

## 3. 공격 시나리오: 원격 코드 실행 (RCE)

**공격 목표:** 서버에서 `id` 명령어 실행하기 (웹 서버 프로세스의 권한 확인)

**공격용 악성 페이로드 (Twig 엔진 기준):**

`{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")()}}`

**공격 과정:**
1.  공격자는 템플릿 엔진의 문법(`{{...}}`)을 사용하여 악성 페이로드를 작성합니다.
2.  `_self.env`를 통해 템플릿 엔진의 내부 환경에 접근합니다.
3.  `registerUndefinedFilterCallback("exec")`를 호출하여, PHP의 위험한 함수인 `exec` (외부 프로그램 실행)를 템플릿 필터로 등록합니다.
4.  `getFilter("id")()`를 통해 방금 등록한 `exec` 필터를 `id`라는 인자와 함께 호출합니다.
5.  결과적으로 서버는 `exec('id')`를 실행하고, 그 결과(예: `uid=33(www-data) gid=33(www-data) groups=33(www-data)`)를 페이지에 렌더링하여 공격자에게 보여줍니다.

---

## 4. 해결책: 샌드박싱 (Sandboxing)

**가장 안전한 방법: 템플릿 엔진을 안전한 모래상자 안에 가두기**

1.  **코드와 데이터 분리 (필수):** 앞서 설명한 바와 같이, 사용자 입력을 템플릿의 일부로 사용하지 않고 오직 데이터로만 전달합니다.
2.  **샌드박스 모드 활성화:** 대부분의 최신 템플릿 엔진은 '샌드박스' 모드를 제공합니다. 이 모드는 템플릿 안에서 사용할 수 있는 태그, 필터, 함수, 객체 등을 제한하여 안전한 환경을 만듭니다.

    ```php
    // Twig 엔진에서 샌드박스를 활성화하는 예시
    $tags = ['if']; // if 태그만 허용
    $filters = ['upper']; // upper 필터만 허용
    $functions = ['range']; // range 함수만 허용
    
    // 보안 정책 설정
    $policy = new \Twig\Sandbox\SecurityPolicy($tags, $filters, $functions);
    $sandbox = new \Twig\Extension\SandboxExtension($policy);
    $twig->addExtension($sandbox);
    ```

**작동 원리:** 공격자가 어떻게든 템플릿 구문을 주입하는 데 성공하더라도, 샌드박스가 위험한 함수나 객체로의 접근을 차단하여 실제적인 피해를 막아주는 '심층 방어' 역할을 합니다.

---

## 5. SSTI 방어 전략

1.  **사용자의 템플릿 수정 금지 (가장 중요):** 사용자 입력은 항상 데이터로 취급하고, 템플릿 자체를 구성하는 데 사용하지 않습니다.
2.  **샌드박스 사용:** 부득이하게 사용자가 템플릿에 일부 영향을 미쳐야 한다면, 반드시 템플릿 엔진의 샌드박스 기능을 활성화하여 안전한 환경을 구성합니다.
3.  **입력값 새니타이제이션:** 보조적인 방어 수단으로, 사용자 입력에서 `{{`, `{%` 등 템플릿 문법과 관련된 특수 문자들을 필터링할 수 있습니다. (하지만 우회 가능성이 높아 주된 방어책이 될 수는 없습니다.)
4.  **템플릿 엔진 최신 버전 유지:** 사용하는 템플릿 엔진을 항상 최신 버전으로 유지하여, 알려진 보안 패치가 모두 적용되도록 합니다.
