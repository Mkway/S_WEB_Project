# Directory Traversal 분석 보고서

## 1. Directory Traversal 이란?

**웹 루트 디렉터리를 벗어나 시스템 파일에 접근하다**

- **정의:** 공격자가 파일 경로를 조작하여, 웹 서버의 루트 디렉터리(`www` 또는 `public_html` 등) 외부의 파일 및 디렉터리에 접근하는 공격 기법입니다. 'Path Traversal'이라고도 불립니다.
- **원리:** 웹 애플리케이션이 사용자로부터 입력받은 파일 이름을 경로의 일부로 사용하여 서버의 파일에 접근할 때, 입력값에 대한 검증이 미흡하면 발생합니다.
- **영향:**
    - **민감 정보 유출:** `/etc/passwd` 같은 시스템 설정 파일이나, 데이터베이스 정보가 담긴 소스 코드를 탈취합니다.
    - **시스템 구조 파악:** 서버의 디렉터리 구조를 파악하여 다른 공격을 위한 정보를 수집합니다.
    - **파일 다운로드:** 서버의 모든 파일을 다운로드할 수 있게 될 수 있습니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 사용자 입력값을 파일 경로에 그대로 결합**

```php
// 사용자가 URL을 통해 요청한 파일 이름
$filename = $_GET['filename'];

// 애플리케이션이 파일을 읽어올 기본 디렉터리
$base_dir = '/var/www/images/';

// 취약한 코드
// 애플리케이션은 images 디렉터리 내의 파일만 보여주려고 의도했습니다.
$file_to_read = $base_dir . $filename;
readfile($file_to_read);
```

**핵심 문제점:** 사용자가 입력한 `filename`에 `../` 같은 상위 디렉터리 이동 문자가 포함될 경우, 이를 필터링하지 않고 파일 경로에 그대로 합쳐서 사용한 것이 문제입니다.

---

## 3. 공격 시나리오: 시스템 파일 읽기

**공격 목표:** 서버의 `/etc/passwd` 파일 읽기

**공격 페이로드:** `../../../../etc/passwd`

**서버에서 처리되는 실제 파일 경로:**

```
/var/www/images/../../../../etc/passwd
```

- 파일 시스템은 `../`를 상위 디렉터리로 이동하는 명령으로 해석합니다.
- `/var/www/images/` 에서 `../`를 네 번 반복하면 결국 최상위 디렉터리(`/`)로 이동하게 됩니다.
- 최종적으로 경로는 `/etc/passwd`로 해석되어, 해당 파일의 내용이 공격자에게 전송됩니다.

---

## 4. 해결책: 경로 정규화 및 검증

**가장 안전한 방법: 절대 경로를 얻어와 허용된 경로인지 확인하기**

```php
// 애플리케이션의 파일 기본 디렉터리
$base_dir = '/var/www/images/';

// 사용자가 요청한 파일 이름
$filename = $_GET['filename'];

// 사용자 입력을 포함한 전체 경로 생성
$user_path = $base_dir . $filename;

// realpath() 함수로 심볼릭 링크 등을 모두 해석한 절대 경로를 얻음
$real_user_path = realpath($user_path);

// 정규화된 경로가 기본 디렉터리 내에 위치하는지 확인
if ($real_user_path && strpos($real_user_path, $base_dir) === 0) {
    // 안전한 경우에만 파일 읽기 실행
    readfile($real_user_path);
} else {
    // 악의적인 요청으로 판단하고 차단
    http_response_code(400);
    echo "잘못된 요청입니다.";
}
```

**작동 원리:**
`realpath()` 함수는 `../`나 `./` 같은 모든 경로 조작 문자를 해석하여 실제 파일 시스템의 절대 경로로 변환합니다. 이 변환된 최종 경로가 여전히 허용된 기본 디렉터리(`$base_dir`)로 시작하는지 검사하여, 디렉터리 외부로의 접근을 원천적으로 차단합니다.

---

## 5. Directory Traversal 방어 전략

1.  **경로 정규화 및 검증 (가장 중요):** `realpath()`와 같은 함수로 경로를 정규화한 후, 허용된 기본 디렉터리 내에 있는지 반드시 확인합니다.
2.  **입력값 필터링:** 사용자 입력에서 `../`, `..
` 등 디렉터리 순회와 관련된 모든 문자열을 제거합니다.
3.  **`basename()` 함수 사용:** 파일 이름만 필요한 경우, `basename()` 함수를 사용하여 경로 정보를 모두 제거하고 순수한 파일 이름만 사용합니다.
4.  **화이트리스트 사용:** 접근 가능한 파일 목록을 미리 정의하고, 이 목록에 있는 파일만 접근을 허용합니다.
5.  **최소 권한 원칙:** 웹 서버 프로세스가 파일 시스템에 접근할 수 있는 권한을 최소한으로 제한합니다.

```