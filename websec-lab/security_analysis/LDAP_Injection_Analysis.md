# LDAP Injection 분석 보고서

## 1. LDAP Injection 이란?

**디렉터리 서비스 질의문 조작하기**

- **LDAP Injection이란?** 웹 애플리케이션이 사용자 입력을 기반으로 LDAP(Lightweight Directory Access Protocol) 쿼리를 동적으로 생성할 때, 공격자가 악의적인 입력을 통해 쿼리의 구조와 의도를 변경하는 공격 기법입니다.
- **원리:** SQL Injection과 매우 유사합니다. 공격자는 LDAP 쿼리에서 특별한 의미를 갖는 메타문자(`*`, `(`, `)`, `&`, `|` 등)를 주입하여, 개발자가 의도한 쿼리를 무력화하고 원하는 결과를 얻어냅니다.
- **영향:**
    - **인증 우회:** 정상적인 아이디와 비밀번호 없이 시스템에 로그인합니다.
    - **정보 유출:** LDAP 디렉터리에 저장된 사용자 계정, 이메일, 조직 구조 등 민감한 정보를 탈취합니다.
    - **권한 상승:** 일반 사용자 계정으로 관리자 권한을 획득합니다.
    - **데이터 조작:** 디렉터리 내의 정보를 임의로 수정하거나 삭제합니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 사용자 입력을 그대로 LDAP 필터에 결합**

```php
// 로그인 폼에서 받은 사용자 입력
$username = $_POST['username'];
$password = $_POST['password'];

// 취약한 LDAP 필터 생성
// 사용자 입력을 아무런 처리 없이 그대로 문자열에 합칩니다.
$filter = "(&(uid=" . $username . ")(userPassword=" . $password . "))";

// 이 필터를 사용하여 LDAP 디렉터리 검색
$search_result = ldap_search($ldap_connection, $base_dn, $filter);
```

**핵심 문제점:** SQL, NoSQL Injection과 마찬가지로, 신뢰할 수 없는 사용자 입력을 검증이나 이스케이프 처리 없이 쿼리문의 일부로 사용하는 것이 모든 문제의 원인입니다.

---

## 3. 공격 시나리오: 인증 우회

**공격 목표:** `admin` 사용자의 비밀번호를 몰라도 로그인하기

**공격용 악성 페이로드:**
- **Username:** `admin)(|(uid=*`
- **Password:** `*)(password=*`

**서버에서 생성되는 실제 LDAP 필터:**
`(&(uid=admin)(|(uid=*)(password=*)(userPassword=*)(password=*)))`

**공격 과정:**
1.  공격자는 `username`과 `password` 필드에 LDAP 필터의 구조를 변경하는 특수문자(`)`, `(`, `|`, `*`)를 주입합니다.
2.  원래 `(&(uid=...)(userPassword=...))` 구조였던 필터가 공격자의 입력으로 인해 복잡한 논리 연산 필터로 변경됩니다.
3.  `(|(uid=*)(password=*))` 부분은 "uid가 존재하거나 password가 존재하면 참"이라는 의미가 되어 항상 참(True)이 됩니다.
4.  결과적으로 전체 필터는 `(&(uid=admin)(TRUE))` 와 같아져, `uid`가 `admin`인 사용자만 찾게 되고 비밀번호 검증은 무시됩니다. 애플리케이션은 `admin` 사용자를 찾았으므로 로그인을 허용합니다.

---

## 4. 해결책: 모든 사용자 입력 이스케이프 처리

**가장 안전한 방법: 특수 문자를 일반 문자로 취급하도록 만들기**

```php
// 로그인 폼에서 받은 사용자 입력
$username = $_POST['username'];
$password = $_POST['password'];

// 안전한 방법
// ldap_escape 함수를 사용하여 특수 문자를 이스케이프 처리합니다.
$escaped_username = ldap_escape($username, "", LDAP_ESCAPE_FILTER);
$escaped_password = ldap_escape($password, "", LDAP_ESCAPE_FILTER);

// 안전하게 처리된 값으로 LDAP 필터 생성
$filter = "(&(uid=" . $escaped_username . ")(userPassword=" . $escaped_password . "))";

// 이제 이 필터를 안전하게 사용할 수 있습니다.
```

**작동 원리:** `ldap_escape()` 함수(또는 각 언어/라이브러리가 제공하는 유사한 기능)는 LDAP 필터에서 특별한 의미를 갖는 모든 메타문자를 일반 문자열로 변환합니다. 예를 들어 `*`는 `\2a`로 변환되어, '모든 것'을 의미하는 와일드카드가 아닌 그냥 별표 문자 자체로 인식됩니다. 이를 통해 공격자가 쿼리의 구조를 변경하는 것을 막을 수 있습니다.

---

## 5. LDAP Injection 방어 전략

1.  **사용자 입력 이스케이프 (필수):** LDAP 쿼리에 사용자 입력을 사용하기 전에, 반드시 검증된 라이브러리 함수를 사용하여 모든 입력을 이스케이프 처리합니다.
2.  **입력값 검증 (화이트리스트):** 전화번호, 이메일 주소 등 입력값의 형식이 정해져 있다면, 허용된 문자 목록(화이트리스트)을 만들어 해당 형식에 맞는지 엄격하게 검증합니다.
3.  **최소 권한 원칙:** 웹 애플리케이션이 LDAP 서버에 연결할 때 사용하는 계정은, 꼭 필요한 최소한의 읽기 권한만 갖도록 제한합니다. 스키마 수정 같은 높은 권한을 절대 부여해서는 안 됩니다.
4.  **프레임워크 사용:** LDAP 연동을 직접 구현하기보다는, LDAP Injection 방어 기능이 내장된 검증된 프레임워크나 라이브러리를 활용하는 것이 안전합니다.
