# IDOR (Insecure Direct Object References) 분석 보고서

## 1. IDOR 이란?

**당신이 볼 수 없는 데이터에 접근하다**

- **정의:** 애플리케이션이 사용자로부터 입력받은 값을 객체(파일, 데이터베이스 레코드 등)에 접근하는 키(key)로 사용하면서, 해당 사용자가 그 객체에 접근할 권한이 있는지 충분히 확인하지 않을 때 발생하는 접근 제어 취약점입니다.
- **원리:** 공격자는 URL 파라미터, 폼 필드 등에 포함된 객체 참조 값(예: `user_id=123`, `file=report.pdf`)을 조작하여 다른 사용자의 데이터에 접근합니다.
- **영향:**
    - **정보 유출:** 다른 사용자의 개인정보, 금융 정보, 비밀 문서 등 민감한 데이터가 노출됩니다.
    - **데이터 조작/삭제:** 다른 사용자의 데이터를 임의로 수정하거나 삭제할 수 있습니다.
    - **권한 상승:** 다른 사용자의 계정을 탈취하거나 관리자 권한을 획득할 수 있습니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 접근 권한 검사의 부재**

```php
// URL을 통해 전달받은 청구서 ID
$invoice_id = $_GET['invoice_id'];

// 취약한 코드
// 애플리케이션은 현재 로그인한 사용자가 해당 청구서의 소유자인지 확인하지 않습니다.
$query = "SELECT * FROM invoices WHERE id = ?";
$stmt = $pdo->prepare($query);
$stmt->execute([$invoice_id]);
$invoice = $stmt->fetch();

// 청구서 내용 표시
// ...
```

**핵심 문제점:** **인증(Authentication)**은 거쳤지만, 특정 데이터에 접근할 **권한(Authorization)**이 있는지 확인하는 절차가 누락되었습니다.

---

## 3. 공격 시나리오: 다른 사용자의 청구서 열람

**공격 목표:** 다른 사용자의 청구서 내역 훔쳐보기

**공격 과정:**
1.  공격자는 자신의 계정으로 로그인하여 `victim.com/invoices?invoice_id=1001` 주소로 자신의 청구서를 확인합니다.
2.  URL에 포함된 `invoice_id` 파라미터가 순차적인 숫자 값임을 인지합니다.
3.  공격자는 `invoice_id` 값을 `1002`, `1003` 등으로 변경하며 다른 청구서에 접근을 시도합니다.
4.  취약한 애플리케이션은 소유권을 확인하지 않으므로, 다른 사용자의 청구서 정보를 그대로 공격자에게 보여줍니다.

---

## 4. 해결책: 모든 요청에 대한 권한 검사

**가장 안전한 방법: 요청된 객체에 현재 사용자가 접근할 권한이 있는지 확인하기**

```php
// URL을 통해 전달받은 청구서 ID
$invoice_id = $_GET['invoice_id'];
// 세션에 저장된 현재 로그인한 사용자의 ID
$current_user_id = $_SESSION['user_id'];

// 안전한 쿼리
// 청구서 ID와 사용자 ID를 모두 조건으로 사용
$query = "SELECT * FROM invoices WHERE id = ? AND user_id = ?";
$stmt = $pdo->prepare($query);
$stmt->execute([$invoice_id, $current_user_id]);
$invoice = $stmt->fetch();

if ($invoice) {
    // 권한이 확인된 경우에만 청구서 내용 표시
    // ...
} else {
    // 권한이 없거나 청구서가 존재하지 않으면, "찾을 수 없음" 에러를 표시
    // (정보 유출을 막기 위해 "권한 없음" 대신 "찾을 수 없음" 사용)
    http_response_code(404);
    echo "청구서를 찾을 수 없습니다.";
}
```

**작동 원리:** 데이터베이스 쿼리 시, 객체의 고유 ID와 함께 현재 사용자의 ID를 `AND` 조건으로 추가합니다. 이를 통해 사용자는 자신의 소유권을 가진 객체에만 접근할 수 있게 됩니다.

---

## 5. IDOR 방어 전략

1.  **접근 제어 구현 (필수):** 개인 데이터에 접근하는 모든 요청에 대해, 현재 사용자가 해당 데이터에 접근할 권한이 있는지 반드시 서버 측에서 검증합니다.
2.  **간접 참조 맵 사용:** 데이터베이스의 실제 ID(Primary Key)를 직접 노출하는 대신, 사용자 세션별로 관리되는 간접적인 참조 값(예: `1, 2, 3...`)을 사용하고, 서버에서 실제 ID로 변환합니다.
3.  **추측 불가능한 ID 사용:** 순차적인 숫자 ID 대신, 복잡하고 예측이 불가능한 `UUID` (Universally Unique Identifier)나 `GUID`를 사용합니다.
4.  **중앙화된 권한 관리:** 모든 요청이 단일화된 접근 제어 로직을 통과하도록 설계하여, 권한 검사 로직이 누락되는 것을 방지합니다.
