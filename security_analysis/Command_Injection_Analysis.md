# Command Injection 분석 보고서

## 1. Command Injection 이란?

**웹 서버의 운영체제(OS)에 임의의 명령어를 실행시키다**

- **정의:** 공격자가 취약한 웹 애플리케이션을 통해, 웹 서버의 운영체제(OS)에 직접 명령어를 실행시키는 공격입니다.
- **원리:** 웹 애플리케이션이 사용자로부터 입력받은 값을 검증 없이 시스템 명령어의 일부로 사용할 때 발생합니다.
- **영향:**
    - **시스템 장악:** 공격자가 웹 서버의 제어권을 완전히 탈취할 수 있습니다.
    - **데이터 유출 및 파괴:** 서버 내의 모든 파일을 읽거나, 수정하고, 삭제할 수 있습니다.
    - **내부망 침투:** 웹 서버를 거점으로 삼아 내부 네트워크의 다른 시스템을 공격할 수 있습니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 사용자 입력값을 그대로 시스템 명령어에 포함**

```php
// 사용자가 입력한 IP 주소
$ip_address = $_POST['ip_address'];

// 취약한 코드
// 애플리케이션은 사용자가 입력한 IP 주소에 ping을 보내려고 의도했습니다.
system("ping -c 1 " . $ip_address);
```

**핵심 문제점:** `system()`, `exec()`, `shell_exec()` 와 같은 함수에 사용자 입력값을 안전하게 처리하지 않고 그대로 전달하는 것이 문제입니다.

---

## 3. 공격 시나리오: 시스템 정보 유출

**공격 목표:** 서버의 주요 파일 목록 확인하기

**공격 페이로드:** `127.0.0.1; ls -la`

**서버에서 실행되는 실제 명령어:**

```sh
ping -c 1 127.0.0.1; ls -la
```

- 셸(Shell)에서 `;` 문자는 앞선 명령어의 성공 여부와 관계없이 다음 명령어를 실행시킵니다.
- 따라서 서버는 `ping` 명령어를 실행한 후, 이어서 `ls -la` 명령어를 실행합니다.
- 공격자는 `ls -la`의 결과(현재 디렉터리의 파일 및 폴더 목록)를 응답으로 받아보게 되며, 이를 통해 추가 공격을 계획할 수 있습니다.

---

## 4. 해결책: `escapeshellarg()` 사용

**가장 안전한 방법: 사용자 입력을 단일 인자로 처리하기**

```php
// 사용자가 입력한 IP 주소
$ip_address = $_POST['ip_address'];

// escapeshellarg() 함수로 안전하게 이스케이프 처리
$safe_ip_address = escapeshellarg($ip_address);

// 안전하게 처리된 인자를 사용하여 명령어 실행
system("ping -c 1 " . $safe_ip_address);
```

**작동 원리:**
`escapeshellarg()` 함수는 사용자 입력값 전체를 작은따옴표(`'`)로 감싸고, 내부의 모든 특수문자를 이스케이프 처리합니다.
- `127.0.0.1; ls -la` → `'127.0.0.1; ls -la'`
- 결과적으로 셸은 이 전체 문자열을 `ping` 명령어의 **단 하나의 인자**로 인식하게 되어, `ls -la`는 명령어로 실행되지 않습니다.

---

## 5. Command Injection 방어 전략

1.  **시스템 명령어 직접 호출 피하기 (가장 중요):** 가능하면 OS 명령어 대신, 해당 프로그래밍 언어가 제공하는 내장 라이브러리나 API를 사용합니다.
2.  **`escapeshellarg()` 또는 `escapeshellcmd()` 사용:** 부득이하게 시스템 명령어를 사용해야 한다면, 반드시 이 함수들을 사용하여 사용자 입력을 안전하게 처리합니다.
3.  **입력값 검증 (화이트리스트 방식):** 허용할 문자와 형식(예: IP 주소 형식)을 미리 정의하고, 이 목록에 없는 입력은 모두 차단합니다.
4.  **최소 권한 원칙:** 웹 서버 데몬(e.g., Apache, Nginx)을 최소한의 권한을 가진 사용자 계정으로 실행하여, 공격이 성공하더라도 피해를 최소화합니다.
