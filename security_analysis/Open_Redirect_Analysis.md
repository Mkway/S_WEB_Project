# Open Redirect 분석 보고서

## 1. 오픈 리다이렉트 (Open Redirect)

**신뢰할 수 있는 사이트에서 악성 사이트로**

- **정의:** 웹 애플리케이션이 사용자 제어 가능한 파라미터(예: `?next=`, `?url=`, `?redirect=`)를 통해 지정된 URL로 사용자를 리다이렉트할 때, 해당 URL을 적절히 검증하지 않아 발생하는 취약점입니다.
- **원리:** 공격자는 신뢰할 수 있는 도메인의 리다이렉트 기능을 악용하여, 사용자를 자신이 원하는 임의의 악성 도메인으로 유도합니다.
- **영향:** 주로 피싱 공격, 멀웨어 배포, OAuth 리다이렉트 하이재킹 등에 활용되어, 사용자가 신뢰하는 도메인의 명성을 악용하여 피해를 입힙니다.

---

## 2. 취약한 코드 분석 (예시)

**문제의 핵심: 검증되지 않은 사용자 제공 URL로 리다이렉트**

```php
// 리다이렉트할 URL을 GET 파라미터에서 직접 가져옵니다.
$redirect_url = $_GET['url'];

// 취약한 코드
// 애플리케이션은 제공된 URL로 사용자를 리다이렉트합니다.
header("Location: " . $redirect_url);
exit();
```

**핵심 문제점:** 리다이렉트할 URL을 사용자 입력에서 직접 가져와 아무런 검증 없이 사용하는 것입니다.

---

## 3. 공격 시나리오: 피싱 (Phishing)

**공격 목표:** 사용자를 가짜 로그인 페이지로 유도하여 자격 증명 탈취하기

**공격용 악성 링크:**
`https://trusted-bank.com/redirect?url=https://fake-bank.com/login`

**공격 과정:**
1.  공격자는 피해자에게 이 링크를 보냅니다. 링크는 신뢰할 수 있는 은행 웹사이트에서 온 것처럼 보입니다.
2.  피해자가 링크를 클릭합니다.
3.  브라우저는 `trusted-bank.com`을 통해 잠시 리다이렉트됩니다.
4.  피해자는 최종적으로 `fake-bank.com/login` 페이지에 도달합니다. 리다이렉트가 신뢰할 수 있는 은행 도메인에서 시작되었기 때문에, 피해자는 가짜 페이지를 더 신뢰하고 로그인 정보를 입력할 가능성이 높아집니다.

---

## 4. 해결책: 화이트리스트 기반 검증

**가장 안전한 방법: 신뢰할 수 있는 내부 URL로만 리다이렉트 허용**

```php
function safeRedirect($url) {
    $parsed_url = parse_url($url);

    // 1. 리다이렉트가 허용된 호스트(도메인) 목록을 정의합니다.
    $allowed_hosts = ['your-domain.com', 'sub.your-domain.com'];

    // 2. 제공된 URL의 호스트가 화이트리스트에 있는지 확인합니다.
    if (isset($parsed_url['host']) && !in_array($parsed_url['host'], $allowed_hosts)) {
        // 허용되지 않은 호스트인 경우, 안전한 기본 페이지로 리다이렉트하거나 에러를 표시합니다.
        header("Location: /error.php");
        exit();
    }

    // 3. 위험한 스키마(예: javascript:, data:)를 확인합니다.
    if (isset($parsed_url['scheme']) && !in_array($parsed_url['scheme'], ['http', 'https'])) {
        header("Location: /error.php");
        exit();
    }

    // 4. 상대 경로인 경우, 디렉터리 순회(../)나 프로토콜 상대( // )가 아닌지 확인합니다.
    if (strpos($url, '/') === 0 && strpos($url, '//') !== 0 && strpos($url, '../') === false) {
        header("Location: " . $url);
        exit();
    }

    // 모든 검증을 통과하면 안전하게 리다이렉트합니다.
    header("Location: " . $url);
    exit();
}
```

**작동 원리:** 이 방식은 애플리케이션이 명시적으로 허용된 내부 또는 화이트리스트에 등록된 외부 도메인으로만 리다이렉트하도록 보장하여, 공격자가 신뢰할 수 있는 도메인을 악용하는 것을 방지합니다.

---

## 5. 오픈 리다이렉트 방어 전략

1.  **화이트리스트 기반 URL 검증 (가장 중요):** 리다이렉트가 허용되는 URL 또는 도메인 목록을 미리 정의하고, 사용자 입력이 이 목록에 포함되는지 엄격하게 검증합니다.
2.  **사용자 제공 리다이렉트 URL 사용 지양:** 가능하다면 리다이렉트 URL을 사용자 입력에서 직접 가져오는 것을 피합니다. 대신, 내부적으로 매핑된 값(예: `?next=1`이 `/dashboard`로 매핑)을 사용합니다.
3.  **URL 구성 요소 검증:** 사용자 제공 URL을 사용할 경우, `parse_url()`과 같은 함수로 URL을 파싱하여 프로토콜, 호스트, 경로 등 모든 구성 요소를 개별적으로 검증합니다.
4.  **위험한 프로토콜 차단:** `javascript:`, `data:`, `file:` 등 웹에서 사용될 경우 위험할 수 있는 프로토콜은 명시적으로 차단합니다.
5.  **사용자 확인 절차:** 외부 도메인으로 리다이렉트하기 전에 사용자에게 경고 메시지를 표시하고, 리다이렉트 여부를 확인하는 절차를 추가합니다.
6.  **URL 인코딩/디코딩 주의:** URL 인코딩/디코딩을 통해 필터링을 우회할 수 있으므로, 검증 전에 URL을 완전히 디코딩해야 합니다.
