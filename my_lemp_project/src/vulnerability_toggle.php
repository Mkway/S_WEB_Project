<?php
session_start();
require_once 'config.php';
require_once 'utils.php';

// 관리자 권한 확인
require_admin();

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $config_file = __DIR__ . '/config.php';
    $config_content = file_get_contents($config_file);
    
    if ($_POST['action'] === 'toggle_vulnerability') {
        // CSRF 토큰 검증
        if (!verify_csrf_token($_POST['csrf_token'] ?? '')) {
            die('CSRF token validation failed.');
        }
        
        // 현재 VULNERABILITY_MODE 상태 확인
        $current_mode = defined('VULNERABILITY_MODE') && VULNERABILITY_MODE === true;
        $new_mode = !$current_mode;
        
        // config.php 파일에서 VULNERABILITY_MODE 값 변경
        if ($new_mode) {
            $config_content = preg_replace(
                "/define\('VULNERABILITY_MODE', false\);/", 
                "define('VULNERABILITY_MODE', true);", 
                $config_content
            );
        } else {
            $config_content = preg_replace(
                "/define\('VULNERABILITY_MODE', true\);/", 
                "define('VULNERABILITY_MODE', false);", 
                $config_content
            );
        }
        
        // 파일에 저장
        if (file_put_contents($config_file, $config_content)) {
            $mode_text = $new_mode ? '활성화' : '비활성화';
            
            // 보안 로그 기록
            if (function_exists('log_security')) {
                log_security('vulnerability_mode_change', "Vulnerability mode changed to: " . ($new_mode ? 'enabled' : 'disabled'), [
                    'admin_user_id' => $_SESSION['user_id'],
                    'previous_mode' => $current_mode,
                    'new_mode' => $new_mode
                ]);
            }
            
            $_SESSION['success_message'] = "취약점 테스트 모드가 {$mode_text}되었습니다.";
        } else {
            $_SESSION['error_message'] = "설정 파일 저장에 실패했습니다.";
        }
    }
}

// 관리자 페이지로 리다이렉트
header('Location: admin.php');
exit;
?>