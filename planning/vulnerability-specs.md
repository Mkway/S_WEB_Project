# 🎯 취약점 상세 스펙

## 1. Business Logic Vulnerability

### 1.1 가격 조작 공격 (Price Manipulation)
**공격 시나리오:**
- 음수 가격으로 환불 받기
- 할인율 100% 이상 적용
- 쿠폰 중복 사용
- 수량과 가격 분리 조작

**구현 계획:**
```php
// 취약한 구현
$total = $_POST['quantity'] * $_POST['price'];

// 안전한 구현  
$total = validate_quantity($input) * get_product_price($product_id);
```

### 1.2 권한 우회 공격 (Authorization Bypass)
**공격 시나리오:**
- 관리자 페이지 직접 접근
- 다른 사용자 ID로 요청 조작
- 역할 기반 접근 제어 우회

### 1.3 워크플로우 우회 (Workflow Bypass)
**공격 시나리오:**
- 결제 없이 주문 완료
- 승인 절차 건너뛰기
- 순서 무시한 API 호출

## 2. Race Condition

### 2.1 TOCTOU (Time-of-Check-Time-of-Use)
**공격 시나리오:**
- 잔액 확인 후 사용 전 조작
- 파일 권한 확인 후 변경
- 중복 결제 처리

**구현 계획:**
```php
// 취약한 구현
if (get_balance($user_id) >= $amount) {
    // 여기서 동시 요청으로 잔액 변경 가능
    sleep(1); // 시뮬레이션
    update_balance($user_id, -$amount);
}

// 안전한 구현 (원자적 연산)
$result = atomic_update_balance($user_id, -$amount);
```

### 2.2 동시성 공격
**공격 시나리오:**
- 동시 로그인으로 세션 충돌
- 파일 업로드 레이스 컨디션
- 카운터 동시 증가

## 3. Advanced Deserialization

### 3.1 Python Pickle 취약점
**공격 시나리오:**
```python
# 악의적인 pickle 데이터
import pickle
import os

class RCE:
    def __reduce__(self):
        return (os.system, ('rm -rf /',))

malicious = pickle.dumps(RCE())
```

### 3.2 .NET BinaryFormatter
**공격 시나리오:**
- ysoserial.net 활용
- .NET 객체 조작
- 원격 코드 실행

### 3.3 PHP Object Injection
**공격 시나리오:**
```php
// 취약한 구현
$user_data = unserialize($_COOKIE['user']);

// 악의적인 쿠키
// O:4:"User":1:{s:4:"role";s:5:"admin";}
```

## 4. 테스트 환경 요구사항

### Docker Services
```yaml
services:
  python_app:    # Python pickle 테스트
  dotnet_app:    # .NET 직렬화 테스트  
  race_test:     # 동시성 테스트용
```

### 필요한 라이브러리
- **Python**: pickle, dill, cloudpickle
- **Node.js**: node-serialize, serialize-javascript
- **.NET**: BinaryFormatter, XmlSerializer
- **PHP**: serialize/unserialize

## 5. 안전한 구현 가이드

### Business Logic 보안
```php
// 1. 서버사이드 검증
function validate_purchase($user_id, $product_id, $quantity, $price) {
    $actual_price = get_product_price($product_id);
    if ($price !== $actual_price) {
        throw new SecurityException("Price tampering detected");
    }
    
    if ($quantity <= 0 || $quantity > MAX_QUANTITY) {
        throw new ValidationException("Invalid quantity");
    }
    
    return calculate_total($actual_price, $quantity);
}

// 2. 권한 확인
function check_authorization($user_id, $resource, $action) {
    $user_role = get_user_role($user_id);
    return has_permission($user_role, $resource, $action);
}
```

### Race Condition 방지
```php
// 1. 원자적 연산 사용
$redis->multi()
      ->decrby("balance:$user_id", $amount)  
      ->incrby("balance:$target_id", $amount)
      ->exec();

// 2. 락 메커니즘
$lock = acquire_lock("transfer:$user_id", 30);
try {
    perform_transfer($user_id, $target_id, $amount);
} finally {
    release_lock($lock);
}
```

### 안전한 직렬화
```php
// 1. JSON 사용 (타입 안전)
$data = json_encode($object);
$object = json_decode($data, true);

// 2. 화이트리스트 기반 직렬화
$allowed_classes = ['User', 'Product', 'Order'];
$object = unserialize($data, ['allowed_classes' => $allowed_classes]);
```