# Vulnerability Mode Analysis

## 1. `vulnerability_toggle.php` 분석

이 스크립트는 애플리케이션의 "취약점 모드"를 토글하는 관리 도구입니다. 관리자가 테스트 및 교육 목적으로 보안 상태와 취약한 상태를 전환할 수 있도록 설계되었습니다.

### 작동 방식:

1.  **관리자 확인:** 사용자가 로그인되어 있고 관리자 권한이 있는지 확인합니다(`require_admin()`).
2.  **CSRF 보호:** 무단 토글을 방지하기 위해 CSRF 토큰 확인(`verify_csrf_token()`)을 포함합니다.
3.  **설정 파일:** `vulnerability_config.json` 파일을 읽고 씁니다. 이 JSON 파일은 `vulnerability_mode`의 현재 상태를 저장합니다.
4.  **토글 로직:** `VULNERABILITY_MODE`의 부울 값을 뒤집거나(정의된 경우) 정의되지 않은 경우 `true`로 설정합니다.
5.  **로깅:** `log_security()`를 사용하여 모드 변경을 기록합니다.
6.  **리디렉션:** 처리 후 `admin.php`로 리다이렉션합니다.

## 2. `vulnerability_toggle.php` 사용 시 코드 변경 사항

`vulnerability_toggle.php` 자체는 애플리케이션의 코드를 직접 변경하지 않습니다. 대신 `vulnerability_config.json`에 저장된 **구성 설정**을 변경합니다.

실제 코드 변경(즉, 보안 조치 활성화/비활성화)은 이 `vulnerability_config.json` 파일을 **읽고** `vulnerability_mode` 설정을 기반으로 작동하는 애플리케이션의 다른 부분에서 발생합니다.

### 핵심 파일: `config.php`

`config.php` 파일은 `vulnerability_config.json`을 읽고 `VULNERABILITY_MODE` 상수를 정의합니다. 이 상수는 애플리케이션 전반에 걸쳐 사용됩니다.

```php
// config.php 스니펫
$vulnerability_mode = true; // 기본값
$config_file = __DIR__ . '/vulnerability_config.json';

if (file_exists($config_file)) {
    $config_data = json_decode(file_get_contents($config_file), true);
    if (isset($config_data['vulnerability_mode'])) {
        $vulnerability_mode = (bool)$config_data['vulnerability_mode'];
    }
}

define('VULNERABILITY_MODE', $vulnerability_mode); // true: 취약점 허용, false: 보안 강화
```

## 3. 코드 변경 예시 및 영향

`VULNERABILITY_MODE` 상수는 보안 조치를 조건부로 활성화하거나 비활성화하는 데 사용됩니다. `VULNERABILITY_MODE`가 `true`이면 애플리케이션은 덜 안전하게 동작하여 특정 취약점을 시연할 수 있습니다. `VULNERABILITY_MODE`가 `false`이면 보안 조치가 적용됩니다.

### 예시 1: `view_post.php` (댓글 표시 및 삭제)

이 파일은 게시물에 달린 댓글을 표시하고, 댓글 삭제 기능을 제공합니다. `VULNERABILITY_MODE`는 **XSS (Cross-Site Scripting)** 및 **CSRF (Cross-Site Request Forgery)** 방어에 직접적인 영향을 미칩니다.

#### 1.1 댓글 내용 표시 (XSS 관련)

*   **취약 모드 (`VULNERABILITY_MODE === true`):**
    ```php
    // view_post.php - 댓글 내용 출력 부분
    echo nl2br($comment['content']); // HTML 엔티티 인코딩 없이 직접 출력
    ```
    *   **영향:** 댓글 내용이 HTML 엔티티 인코딩 없이 HTML에 직접 출력됩니다. 이는 페이지를 **저장형 XSS**에 취약하게 만듭니다. 공격자가 악성 JavaScript(예: `<script>alert('XSS')</script>`)가 포함된 댓글을 게시하면, 해당 스크립트는 게시물을 보는 모든 사용자의 브라우저에서 실행됩니다.
    *   **보안 영향:** **높은 위험**. 공격자에 의한 클라이언트 측 코드 실행을 허용하여 세션 하이재킹, 웹사이트 변조, 피싱 등으로 이어질 수 있습니다.

*   **보안 모드 (`VULNERABILITY_MODE === false`):**
    ```php
    // view_post.php - 댓글 내용 출력 부분
    echo nl2br(htmlspecialchars($comment['content'])); // HTML 엔티티 인코딩 적용
    ```
    *   **영향:** 댓글 내용은 `htmlspecialchars()`를 통해 처리되어 특수 HTML 문자(`>`, `<`, `&`, `"`, `'`)를 HTML 엔티티로 변환합니다. 이는 삽입된 HTML 태그나 JavaScript를 무력화하여 일반 텍스트로 렌더링합니다.
    *   **보안 영향:** **안전**. 클라이언트 측 코드 삽입을 방지하여 XSS 공격으로부터 보호합니다.

#### 1.2 댓글 삭제 링크 (CSRF 관련)

*   **취약 모드 (`VULNERABILITY_MODE === true`):**
    ```php
    // view_post.php - 댓글 삭제 링크 생성 부분
    $delete_url = "delete_comment.php?id=" . $comment['id'] . "&post_id=" . $post['id'];
    // CSRF 토큰이 URL에 추가되지 않음
    ```
    *   **영향:** 댓글 삭제 작업이 **CSRF (Cross-Site Request Forgery)**에 취약해집니다. 공격자는 로그인한 사용자가 공격자의 페이지를 방문할 때 댓글 삭제를 자동으로 트리거하는 악성 페이지를 만들 수 있습니다. 서버는 CSRF 토큰이 없으므로 요청의 출처를 확인하지 않고 이 요청을 처리합니다.
    *   **보안 영향:** **높은 위험**. 공격자가 사용자에게 의도하지 않은 작업을 강제로 수행하도록 허용합니다.

*   **보안 모드 (`VULNERABILITY_MODE === false`):**
    ```php
    // view_post.php - 댓글 삭제 링크 생성 부분
    $delete_url = "delete_comment.php?id=" . $comment['id'] . "&post_id=" . $post['id'];
    $delete_url .= "&csrf_token=" . generate_csrf_token(); // CSRF 토큰 추가
    ```
    *   **영향:** 댓글 삭제 작업은 고유한 CSRF 토큰으로 보호됩니다. 서버 측 `delete_comment.php`는 유효한 세션 바인딩 CSRF 토큰을 포함하지 않는 모든 요청을 거부합니다.
    *   **보안 영향:** **안전**. CSRF 공격으로부터 보호합니다.

### 예시 2: `create_post.php` (게시물 생성 및 파일 업로드)

이 파일은 새 게시물을 생성하고 파일을 업로드하는 기능을 담당합니다. `VULNERABILITY_MODE`는 **무제한 파일 업로드** 취약점 방어에 직접적인 영향을 미칩니다.

#### 2.1 파일 업로드 유효성 검사

*   **취약 모드 (`VULNERABILITY_MODE === true`):**
    ```php
    // create_post.php - 파일 업로드 유효성 검사 부분
    // 취약점 모드: 파일 업로드 제한 없음 (교육 목적)
    // ... (확장자, 크기, 내용 검사 로직이 실행되지 않음) ...
    ```
    *   **영향:** 파일 업로드 유효성 검사 로직(허용된 확장자, 파일 크기 제한, 위험한 내용 검사)이 대부분 우회됩니다. 공격자는 악성 파일(예: PHP 웹 셸, JavaScript 파일, 실행 파일)을 서버에 업로드할 수 있으며, 서버가 이러한 파일을 실행하도록 구성된 경우 **원격 코드 실행 (RCE)**을 달성할 수 있습니다.
    *   **보안 영향:** **치명적인 위험**. 임의 파일 업로드 및 잠재적인 RCE를 허용합니다.

*   **보안 모드 (`VULNERABILITY_MODE === false`):**
    ```php
    // create_post.php - 파일 업로드 유효성 검사 부분
    // 안전한 모드: 파일 확장자 및 크기 검증
    if (!in_array($file_extension, $allowed_extensions)) { /* ... */ }
    if ($_FILES['files']['size'][$key] > MAX_FILE_SIZE) { /* ... */ }
    if (strpos($file_content, '<?php') !== false || strpos($file_content, '<script') !== false) { /* ... */ }
    ```
    *   **영향:** 엄격한 유효성 검사 규칙이 적용됩니다. 허용된 확장자만 허용하고, 파일 크기를 제한하며, `<?php`나 `<script`와 같은 위험한 내용이 포함된 파일을 거부합니다.
    *   **보안 영향:** **안전**. 악성 파일 업로드를 방지하여 RCE와 같은 심각한 공격으로부터 보호합니다.

### 예시 3: `jwt_test.php` (JWT 취약점 테스트)

이 파일은 JWT (JSON Web Token) 취약점을 시뮬레이션하며, `VULNERABILITY_MODE`는 다양한 JWT 공격 시나리오의 성공 여부에 영향을 미칩니다.

*   **취약 모드 (`VULNERABILITY_MODE === true`):**
    *   **영향:** `verifyJWT` 함수 내에서 `alg: none` 알고리즘을 허용하거나, `RS256` 토큰을 `HS256` 시크릿 키로 검증하는 알고리즘 혼동 공격을 시뮬레이션합니다. 이는 공격자가 서명 검증 없이 토큰을 위조하거나, 공개 키를 사용하여 토큰을 위조할 수 있게 합니다.
    *   **보안 영향:** **높은 위험**. 인증 우회, 권한 상승, 데이터 조작으로 이어질 수 있습니다.

*   **보드 모드 (`VULNERABILITY_MODE === false`):**
    *   **영향:** `verifyJWT` 함수는 `alg: none` 알고리즘을 거부하고, 알고리즘 혼동 공격을 방어합니다. 토큰은 올바른 시크릿 키와 알고리즘으로만 검증됩니다.
    *   **보안 영향:** **안전**. JWT 위조 공격으로부터 보호합니다.

### 예시 4: `admin.php` (관리자 패널 표시)

이 파일은 관리자 패널의 UI를 표시하며, `VULNERABILITY_MODE`에 따라 사용자에게 현재 모드 상태를 시각적으로 알려줍니다.

*   **취약 모드 (`VULNERABILITY_MODE === true`):**
    ```php
    // admin.php - UI 표시 부분
    <?php if (defined('VULNERABILITY_MODE') && VULNERABILITY_MODE === true): ?>
        <div class="vulnerability-mode-warning">
            ⚠️ 취약점 테스트 모드 활성화 (교육 목적)
        </div>
    <?php endif; ?>
    <?php echo (defined('VULNERABILITY_MODE') && VULNERABILITY_MODE === true) ? '🛡️ 보안 모드로 전환' : '⚠️ 취약점 모드로 전환'; ?>
    ```
    *   **영향:** 관리자 패널 상단에 "⚠️ 취약점 테스트 모드 활성화" 경고 배너가 표시됩니다. 또한, 모드 전환 버튼의 텍스트가 "🛡️ 보안 모드로 전환"으로 변경되어, 현재 애플리케이션이 취약점 테스트 모드임을 명확히 인지할 수 있도록 합니다.
    *   **보안 영향:** **정보 제공**. 관리자에게 현재 애플리케이션의 보안 상태를 시각적으로 명확하게 알려주어, 의도치 않은 취약 모드 사용을 방지합니다.

*   **보안 모드 (`VULNERABILITY_MODE === false`):**
    *   **영향:** 경고 배너가 표시되지 않으며, 모드 전환 버튼의 텍스트가 "⚠️ 취약점 모드로 전환"으로 변경됩니다. 이는 애플리케이션이 보안 모드임을 나타냅니다.
    *   **보안 영향:** **정보 제공**. 애플리케이션이 안전한 상태임을 관리자에게 알려줍니다.

## 4. 토글링의 영향

*   **취약 모드 (`VULNERABILITY_MODE = true`):**
    *   **목적:** 교육 및 테스트 목적. 다양한 웹 취약점 시연을 허용합니다.
    *   **영향:** 애플리케이션이 의도적으로 안전하지 않게 됩니다. 입력 정제, 준비된 문, 엄격한 유효성 검사와 같은 보안 조치가 우회되거나 약화될 수 있습니다. 이를 통해 공격자(또는 테스터)는 SQL Injection, XSS 등과 같은 취약점을 성공적으로 악용할 수 있습니다.
    *   **위험:** **높음**. 프로덕션 환경에서는 절대 사용해서는 안 됩니다. 데이터가 손상될 수 있으며 서버가 장악될 수 있습니다.

*   **보안 모드 (`VULNERABILITY_MODE = false`):**
    *   **목적:** 웹 애플리케이션을 올바르게 보호하는 방법을 시연합니다.
    *   **영향:** 애플리케이션은 보안 모범 사례를 적용합니다. 입력은 정제되고, 준비된 문이 사용되며, 다른 보안 제어가 활성화됩니다. 이는 취약 모드에서 시연된 취약점의 성공적인 악용을 방지합니다.
    *   **이점:** 개발 및 배포를 위한 안전한 기준을 제공합니다.

## 5. 요약

`vulnerability_toggle.php`는 `vulnerability_config.json`의 설정을 변경합니다. 이 설정은 `config.php`에서 읽혀 `VULNERABILITY_MODE` 상수를 정의합니다. 애플리케이션의 다른 PHP 파일들은 이 상수를 사용하여 보안 기능을 조건부로 활성화하거나 비활성화하여, 교육 목적으로 애플리케이션을 보안 상태와 의도적으로 취약한 상태 사이에서 전환합니다.

이를 통해 프로젝트는 취약한 코드와 안전한 코드 모두에 대한 실용적인 시연 역할을 할 수 있습니다.
