<?php
session_start();
require_once 'config.php';
require_once 'utils.php';

// 관리자 권한 확인
require_admin();

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $config_file = __DIR__ . '/vulnerability_config.json';
    
    if ($_POST['action'] === 'toggle_vulnerability') {
        // CSRF 토큰 검증
        if (!verify_csrf_token($_POST['csrf_token'] ?? '')) {
            die('CSRF token validation failed.');
        }
        
        // 현재 VULNERABILITY_MODE 상태 확인
        $current_mode = defined('VULNERABILITY_MODE') && VULNERABILITY_MODE === true;
        $new_mode = !$current_mode;
        
        // JSON 설정 파일 업데이트
        $config_data = [
            'vulnerability_mode' => $new_mode,
            'last_updated' => date('Y-m-d H:i:s'),
            'updated_by' => $_SESSION['username'] ?? 'unknown'
        ];
        
        // JSON 파일에 저장
        if (file_put_contents($config_file, json_encode($config_data, JSON_PRETTY_PRINT))) {
            $mode_text = $new_mode ? '활성화' : '비활성화';
            
            // 보안 로그 기록
            if (function_exists('log_security')) {
                log_security('vulnerability_mode_change', "Vulnerability mode changed to: " . ($new_mode ? 'enabled' : 'disabled'), [
                    'admin_user_id' => $_SESSION['user_id'],
                    'admin_username' => $_SESSION['username'],
                    'previous_mode' => $current_mode,
                    'new_mode' => $new_mode,
                    'config_file' => 'vulnerability_config.json'
                ]);
            }
            
            $_SESSION['success_message'] = "취약점 테스트 모드가 {$mode_text}되었습니다. (페이지 새로고침 후 적용)";
        } else {
            $_SESSION['error_message'] = "설정 파일 저장에 실패했습니다. 파일 권한을 확인하세요.";
            
            // 권한 문제 로깅
            if (function_exists('log_error')) {
                log_error('vulnerability_toggle_failed', 'Failed to write vulnerability config file', [
                    'config_file' => $config_file,
                    'file_exists' => file_exists($config_file),
                    'is_writable' => is_writable($config_file),
                    'directory_writable' => is_writable(dirname($config_file))
                ]);
            }
        }
    }
}

// 관리자 페이지로 리다이렉트
header('Location: admin.php');
exit;
?>