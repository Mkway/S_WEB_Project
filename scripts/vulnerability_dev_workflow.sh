#!/bin/bash

# ==============================================
# S_WEB_Project ì·¨ì•½ì  ê°œë°œ ì›Œí¬í”Œë¡œìš° ìŠ¤í¬ë¦½íŠ¸
# ==============================================

set -e  # ì˜¤ë¥˜ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬
PROJECT_ROOT="/home/wsl/S_WEB_Project"
WEBSEC_LAB_DIR="$PROJECT_ROOT/websec-lab/src/webhacking"

# ë¡œê·¸ íŒŒì¼
LOG_FILE="$PROJECT_ROOT/log/dev_workflow_$(date +%Y_%m_%d).log"

# ë¡œê¹… í•¨ìˆ˜
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ì§„í–‰ ìƒí™© í‘œì‹œ í•¨ìˆ˜
show_progress() {
    echo -e "${BLUE}ğŸ”„ $1${NC}"
    log "PROGRESS: $1"
}

# ì„±ê³µ ë©”ì‹œì§€ í•¨ìˆ˜
show_success() {
    echo -e "${GREEN}âœ… $1${NC}"
    log "SUCCESS: $1"
}

# ê²½ê³  ë©”ì‹œì§€ í•¨ìˆ˜
show_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
    log "WARNING: $1"
}

# ì˜¤ë¥˜ ë©”ì‹œì§€ í•¨ìˆ˜
show_error() {
    echo -e "${RED}âŒ $1${NC}"
    log "ERROR: $1"
}

# ì·¨ì•½ì  ëª©ë¡ ì •ì˜
declare -A VULNERABILITIES=(
    ["xxe"]="XXE (XML External Entity)"
    ["ssrf"]="SSRF (Server-Side Request Forgery)"
    ["ssti"]="SSTI (Server-Side Template Injection)"
    ["open_redirect"]="Open Redirect"
    ["xpath"]="XPath Injection"
)

# ë©”ì¸ í•¨ìˆ˜
main() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "ğŸš€ S_WEB_Project ì·¨ì•½ì  ê°œë°œ ì›Œí¬í”Œë¡œìš°"
    echo "=================================================="
    echo -e "${NC}"
    
    # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$(dirname "$LOG_FILE")"
    log "ì›Œí¬í”Œë¡œìš° ì‹œì‘"
    
    # ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
    if [[ ! -d "$WEBSEC_LAB_DIR" ]]; then
        show_error "ì›¹ë³´ì•ˆ ë© ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $WEBSEC_LAB_DIR"
        exit 1
    fi
    
    # Git ìƒíƒœ í™•ì¸
    cd "$PROJECT_ROOT"
    if ! git status &>/dev/null; then
        show_error "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤."
        exit 1
    fi
    
    # ì·¨ì•½ì  ì„ íƒ
    select_vulnerability
}

# ì·¨ì•½ì  ì„ íƒ í•¨ìˆ˜
select_vulnerability() {
    echo -e "${BLUE}ë‹¤ìŒ ì¤‘ ì‘ì—…í•  ì·¨ì•½ì ì„ ì„ íƒí•˜ì„¸ìš”:${NC}"
    echo ""
    
    local i=1
    local vuln_keys=()
    
    for vuln_key in "${!VULNERABILITIES[@]}"; do
        vuln_keys+=("$vuln_key")
        echo "  $i) ${VULNERABILITIES[$vuln_key]}"
        ((i++))
    done
    
    echo ""
    read -p "ì„ íƒ (1-${#VULNERABILITIES[@]}): " choice
    
    if [[ "$choice" -ge 1 && "$choice" -le ${#VULNERABILITIES[@]} ]]; then
        local selected_vuln="${vuln_keys[$((choice-1))]}"
        show_success "ì„ íƒëœ ì·¨ì•½ì : ${VULNERABILITIES[$selected_vuln]}"
        start_development_workflow "$selected_vuln"
    else
        show_error "ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤."
        exit 1
    fi
}

# ê°œë°œ ì›Œí¬í”Œë¡œìš° ì‹œì‘ í•¨ìˆ˜
start_development_workflow() {
    local vuln_type="$1"
    local vuln_name="${VULNERABILITIES[$vuln_type]}"
    
    show_progress "[$vuln_name] ê°œë°œ ì›Œí¬í”Œë¡œìš° ì‹œì‘"
    
    # Phase 1: ë¶„ì„ ë‹¨ê³„
    analyze_current_state "$vuln_type"
    
    # Phase 2: êµ¬í˜„ ì¤€ë¹„
    prepare_implementation "$vuln_type"
    
    # Phase 3: í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
    show_quality_checklist "$vuln_type"
    
    # Phase 4: ê°œë°œ í™˜ê²½ ì¤€ë¹„
    prepare_dev_environment
    
    show_success "[$vuln_name] ê°œë°œ ì›Œí¬í”Œë¡œìš° ì¤€ë¹„ ì™„ë£Œ!"
    echo ""
    echo -e "${YELLOW}ë‹¤ìŒ ë‹¨ê³„:${NC}"
    echo "1. Claude Codeë¥¼ í†µí•´ ì‹¤ì œ êµ¬í˜„ ì‹œì‘"
    echo "2. ê° ë‹¨ê³„ë§ˆë‹¤ í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í™•ì¸"
    echo "3. êµ¬í˜„ ì™„ë£Œ í›„ ./scripts/vulnerability_test.shë¡œ í…ŒìŠ¤íŠ¸"
    echo "4. ./scripts/vulnerability_commit.shë¡œ ìë™ ì»¤ë°‹"
}

# í˜„ì¬ ìƒíƒœ ë¶„ì„ í•¨ìˆ˜
analyze_current_state() {
    local vuln_type="$1"
    
    show_progress "[$vuln_type] í˜„ì¬ ìƒíƒœ ë¶„ì„ ì¤‘..."
    
    local test_file="$WEBSEC_LAB_DIR/${vuln_type}_test.php"
    
    if [[ -f "$test_file" ]]; then
        show_success "í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬: $test_file"
        
        # ì‹¤ì œ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸ (ê°„ë‹¨í•œ íŒ¨í„´ ë§¤ì¹­)
        if grep -q "ì‹œë®¬ë ˆì´ì…˜\|simulation" "$test_file"; then
            show_warning "í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì¶”ì •ë©ë‹ˆë‹¤."
            log "ANALYSIS: $vuln_type - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œì—ì„œ ì‹¤ì œ ì‹¤í–‰ ëª¨ë“œë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”"
        else
            show_success "ì‹¤ì œ ì‹¤í–‰ ëª¨ë“œë¡œ ì¶”ì •ë©ë‹ˆë‹¤."
            log "ANALYSIS: $vuln_type - ì´ë¯¸ ì‹¤ì œ ì‹¤í–‰ ëª¨ë“œ"
        fi
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        local file_size=$(wc -l < "$test_file")
        log "ANALYSIS: $vuln_type - íŒŒì¼ ë¼ì¸ ìˆ˜: $file_size"
        
    else
        show_warning "í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $test_file"
        log "ANALYSIS: $vuln_type - í…ŒìŠ¤íŠ¸ íŒŒì¼ ë¯¸ì¡´ì¬, ìƒˆë¡œ ìƒì„± í•„ìš”"
    fi
}

# êµ¬í˜„ ì¤€ë¹„ í•¨ìˆ˜
prepare_implementation() {
    local vuln_type="$1"
    
    show_progress "[$vuln_type] êµ¬í˜„ í™˜ê²½ ì¤€ë¹„ ì¤‘..."
    
    # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
    local backup_dir="$PROJECT_ROOT/backup/$(date +%Y%m%d_%H%M%S)_${vuln_type}"
    mkdir -p "$backup_dir"
    
    local test_file="$WEBSEC_LAB_DIR/${vuln_type}_test.php"
    
    if [[ -f "$test_file" ]]; then
        cp "$test_file" "$backup_dir/"
        show_success "ì›ë³¸ íŒŒì¼ ë°±ì—… ì™„ë£Œ: $backup_dir"
    fi
    
    log "BACKUP: $vuln_type íŒŒì¼ ë°±ì—… ì™„ë£Œ - $backup_dir"
}

# í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
show_quality_checklist() {
    local vuln_type="$1"
    
    echo ""
    echo -e "${PURPLE}ğŸ“‹ [$vuln_type] ê°œë°œ í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸${NC}"
    echo "=================================================="
    echo ""
    echo -e "${BLUE}ğŸ¯ êµ¬í˜„ ìš”êµ¬ì‚¬í•­:${NC}"
    echo "  â–¡ ì‹¤ì œ ì·¨ì•½ì  ì‹¤í–‰ (ì‹œë®¬ë ˆì´ì…˜ âŒ)"
    echo "  â–¡ ì·¨ì•½í•œ vs ì•ˆì „í•œ êµ¬í˜„ ë¹„êµ"
    echo "  â–¡ ì»¬ëŸ¬ ì½”ë”©ëœ ê²°ê³¼ í‘œì‹œ"
    echo "  â–¡ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ ì„¹ì…˜ í¬í•¨"
    echo ""
    echo -e "${BLUE}ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­:${NC}"
    echo "  â–¡ êµìœ¡ ëª©ì ì„ì„ ëª…ì‹œ"
    echo "  â–¡ ì‹¤ì œ ì‹œìŠ¤í…œ í”¼í•´ ë°©ì§€ ì¡°ì¹˜"
    echo "  â–¡ ì ì ˆí•œ ì—ëŸ¬ í•¸ë“¤ë§"
    echo ""
    echo -e "${BLUE}ğŸ“ ì½”ë“œ í’ˆì§ˆ:${NC}"
    echo "  â–¡ PHP í‘œì¤€ ì½”ë”© ìŠ¤íƒ€ì¼ ì¤€ìˆ˜"
    echo "  â–¡ ì ì ˆí•œ ì£¼ì„ ì¶”ê°€"
    echo "  â–¡ ì…ë ¥ ê°’ ê²€ì¦"
    echo ""
    echo -e "${BLUE}ğŸ§ª í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­:${NC}"
    echo "  â–¡ ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸"
    echo "  â–¡ ë‹¤ì–‘í•œ í˜ì´ë¡œë“œ í…ŒìŠ¤íŠ¸"
    echo "  â–¡ ì—ëŸ¬ ìƒí™© ì²˜ë¦¬ í™•ì¸"
    echo ""
    echo -e "${BLUE}ğŸ“š ë¬¸ì„œí™”:${NC}"
    echo "  â–¡ ìƒì„¸í•œ ì»¤ë°‹ ë©”ì‹œì§€"
    echo "  â–¡ ë³´ì•ˆ ë¶„ì„ ë¬¸ì„œ ì—…ë°ì´íŠ¸"
    echo "  â–¡ êµ¬í˜„ ë‚´ìš© ë¡œê·¸ ê¸°ë¡"
}

# ê°œë°œ í™˜ê²½ ì¤€ë¹„ í•¨ìˆ˜
prepare_dev_environment() {
    show_progress "ê°œë°œ í™˜ê²½ ì ê²€ ì¤‘..."
    
    # PHP ë¬¸ë²• ì²´í¬ (ë§Œì•½ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´)
    if command -v php &> /dev/null; then
        show_success "PHP ì‚¬ìš© ê°€ëŠ¥"
    else
        show_warning "PHPê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    fi
    
    # Git ìƒíƒœ í™•ì¸
    if git diff --quiet; then
        show_success "Git ì‘ì—… ë””ë ‰í† ë¦¬ clean"
    else
        show_warning "ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤."
        git status --short
    fi
    
    log "DEV_ENV: ê°œë°œ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"