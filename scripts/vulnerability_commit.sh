#!/bin/bash

# ==============================================
# S_WEB_Project ì·¨ì•½ì  ìë™ ì»¤ë°‹ ìŠ¤í¬ë¦½íŠ¸
# ==============================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_ROOT="/home/wsl/S_WEB_Project"
COMMIT_LOG="$PROJECT_ROOT/log/commit_history_$(date +%Y%m%d).log"

# ì·¨ì•½ì  íƒ€ì…ë³„ í•œê¸€ ì´ë¦„ ë§¤í•‘
declare -A VULN_KOREAN_NAMES=(
    ["xxe"]="XXE ì™¸ë¶€ ì—”í‹°í‹° ê³µê²©"
    ["ssrf"]="SSRF ì„œë²„ ì¸¡ ìš”ì²­ ìœ„ì¡°"
    ["ssti"]="SSTI ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì¸ì ì…˜"
    ["open_redirect"]="ì˜¤í”ˆ ë¦¬ë‹¤ì´ë ‰íŠ¸"
    ["xpath"]="XPath ì¸ì ì…˜"
    ["sql_injection"]="SQL ì¸ì ì…˜"
    ["xss"]="XSS í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…"
    ["command_injection"]="ëª…ë ¹ì–´ ì¸ì ì…˜"
    ["file_upload"]="íŒŒì¼ ì—…ë¡œë“œ"
    ["csrf"]="CSRF í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ ìœ„ì¡°"
    ["file_inclusion"]="íŒŒì¼ ì¸í´ë£¨ì „"
    ["directory_traversal"]="ë””ë ‰í† ë¦¬ íŠ¸ë˜ë²„ì„¤"
    ["auth_bypass"]="ì¸ì¦ ìš°íšŒ"
)

# ë¡œê¹… í•¨ìˆ˜
log_commit() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$COMMIT_LOG"
}

# ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜ë“¤
show_commit_progress() {
    echo -e "${BLUE}ğŸ“¦ $1${NC}"
    log_commit "COMMIT_PROGRESS: $1"
}

show_commit_success() {
    echo -e "${GREEN}âœ… $1${NC}"
    log_commit "COMMIT_SUCCESS: $1"
}

show_commit_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
    log_commit "COMMIT_WARNING: $1"
}

show_commit_error() {
    echo -e "${RED}âŒ $1${NC}"
    log_commit "COMMIT_ERROR: $1"
}

# ë©”ì¸ í•¨ìˆ˜
main() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "ğŸ“¦ S_WEB_Project ìë™ ì»¤ë°‹ ì‹œìŠ¤í…œ"
    echo "=================================================="
    echo -e "${NC}"
    
    # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$(dirname "$COMMIT_LOG")"
    log_commit "ìë™ ì»¤ë°‹ í”„ë¡œì„¸ìŠ¤ ì‹œì‘"
    
    # Git ì €ì¥ì†Œ í™•ì¸
    cd "$PROJECT_ROOT"
    if ! git status &>/dev/null; then
        show_commit_error "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤."
        exit 1
    fi
    
    # ì¸ì í™•ì¸
    if [[ $# -eq 0 ]]; then
        interactive_commit
    else
        automatic_commit "$1"
    fi
}

# ëŒ€í™”í˜• ì»¤ë°‹ í”„ë¡œì„¸ìŠ¤
interactive_commit() {
    show_commit_progress "ëŒ€í™”í˜• ì»¤ë°‹ ëª¨ë“œ ì‹œì‘"
    
    # Git ìƒíƒœ í™•ì¸
    show_commit_progress "Git ìƒíƒœ í™•ì¸ ì¤‘..."
    git status
    
    if git diff --quiet && git diff --cached --quiet; then
        show_commit_warning "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        return 0
    fi
    
    echo ""
    echo -e "${BLUE}ì–´ë–¤ ìœ í˜•ì˜ ì»¤ë°‹ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${NC}"
    echo "1) ì·¨ì•½ì  ê¸°ëŠ¥ ê°œë°œ/ìˆ˜ì •"
    echo "2) ë²„ê·¸ ìˆ˜ì •"
    echo "3) ë¦¬íŒ©í† ë§"
    echo "4) ë¬¸ì„œ ì—…ë°ì´íŠ¸"
    echo "5) í…ŒìŠ¤íŠ¸ ì¶”ê°€/ìˆ˜ì •"
    echo "6) ê¸°íƒ€ ë³€ê²½ì‚¬í•­"
    echo ""
    
    read -p "ì„ íƒ (1-6): " commit_type
    
    case $commit_type in
        1) handle_vulnerability_commit ;;
        2) handle_bugfix_commit ;;
        3) handle_refactor_commit ;;
        4) handle_docs_commit ;;
        5) handle_test_commit ;;
        6) handle_other_commit ;;
        *) show_commit_error "ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤."; exit 1 ;;
    esac
}

# ì·¨ì•½ì  ê¸°ëŠ¥ ì»¤ë°‹ ì²˜ë¦¬
handle_vulnerability_commit() {
    show_commit_progress "ì·¨ì•½ì  ê¸°ëŠ¥ ì»¤ë°‹ ì²˜ë¦¬ ì¤‘..."
    
    # ë³€ê²½ëœ ì·¨ì•½ì  íŒŒì¼ ê°ì§€
    local changed_vulns=()
    
    for vuln_file in $(git diff --name-only --cached | grep "_test\.php$"); do
        local vuln_name=$(basename "$vuln_file" "_test.php")
        changed_vulns+=("$vuln_name")
    done
    
    if [[ ${#changed_vulns[@]} -eq 0 ]]; then
        # ìŠ¤í…Œì´ì§•ë˜ì§€ ì•Šì€ íŒŒì¼ë„ í™•ì¸
        for vuln_file in $(git diff --name-only | grep "_test\.php$"); do
            local vuln_name=$(basename "$vuln_file" "_test.php")
            changed_vulns+=("$vuln_name")
        done
    fi
    
    if [[ ${#changed_vulns[@]} -eq 0 ]]; then
        show_commit_warning "ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ íŒŒì¼ ë³€ê²½ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "ì¼ë°˜ ê¸°ëŠ¥ ì»¤ë°‹ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
        handle_other_commit
        return
    fi
    
    # ì£¼ ì·¨ì•½ì  ì„ íƒ (ì²« ë²ˆì§¸ ê²ƒ)
    local main_vuln="${changed_vulns[0]}"
    local korean_name="${VULN_KOREAN_NAMES[$main_vuln]:-$main_vuln}"
    
    echo ""
    echo -e "${BLUE}ê°ì§€ëœ ì·¨ì•½ì : $korean_name${NC}"
    echo ""
    
    # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
    generate_vulnerability_commit_message "$main_vuln" "$korean_name"
}

# ì·¨ì•½ì  ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
generate_vulnerability_commit_message() {
    local vuln_type="$1"
    local korean_name="$2"
    
    show_commit_progress "[$vuln_type] ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„± ì¤‘..."
    
    # ë³€ê²½ì‚¬í•­ ë¶„ì„
    local changes=()
    local commit_title=""
    
    # Git diffë¡œ ë³€ê²½ì‚¬í•­ ë¶„ì„
    if git diff --cached --quiet; then
        # ìŠ¤í…Œì´ì§•ëœ ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
        git add .
    fi
    
    local diff_output=$(git diff --cached)
    
    # ë³€ê²½ì‚¬í•­ íŒ¨í„´ ë¶„ì„
    if echo "$diff_output" | grep -q "ì‹¤ì œ.*ì‹¤í–‰\|real.*execution"; then
        commit_title="feat: $korean_name ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„"
        changes+=("ì‹œë®¬ë ˆì´ì…˜ì—ì„œ ì‹¤ì œ ê³µê²© ì‹¤í–‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ")
    elif echo "$diff_output" | grep -q "ì‹œë®¬ë ˆì´ì…˜\|simulation"; then
        commit_title="feat: $korean_name ì‹œë®¬ë ˆì´ì…˜ ê¸°ëŠ¥ ê°œì„ "
        changes+=("ì‹œë®¬ë ˆì´ì…˜ ê¸°ëŠ¥ í–¥ìƒ ë° ì‚¬ìš©ì ê²½í—˜ ê°œì„ ")
    else
        commit_title="feat: $korean_name ê¸°ëŠ¥ ê°œì„ "
        changes+=("ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ê°œì„ ")
    fi
    
    # ì¶”ê°€ ë³€ê²½ì‚¬í•­ ê°ì§€
    if echo "$diff_output" | grep -q "vulnerable.*output\|safe.*comparison"; then
        changes+=("ì·¨ì•½í•œ vs ì•ˆì „í•œ êµ¬í˜„ ë¹„êµ ê¸°ëŠ¥ ì¶”ê°€")
    fi
    
    if echo "$diff_output" | grep -q "color\|class.*red\|class.*green"; then
        changes+=("ì»¬ëŸ¬ ì½”ë”©ëœ ê²°ê³¼ í‘œì‹œ ê¸°ëŠ¥ êµ¬í˜„")
    fi
    
    if echo "$diff_output" | grep -q "defense\|ë³´ì•ˆ.*ê¶Œê³ \|ë°©ì–´.*ë°©ë²•"; then
        changes+=("ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ ë° ë°©ì–´ ë°©ë²• ìƒì„¸í™”")
    fi
    
    if echo "$diff_output" | grep -q "payload"; then
        changes+=("ë‹¤ì–‘í•œ ê³µê²© í˜ì´ë¡œë“œ ì¶”ê°€ ë° ê°œì„ ")
    fi
    
    # ê¸°ë³¸ ë³€ê²½ì‚¬í•­ ì¶”ê°€ (ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš°)
    if [[ ${#changes[@]} -eq 1 ]]; then
        changes+=("ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ë° ê²½í—˜ ê°œì„ ")
        changes+=("ì½”ë“œ í’ˆì§ˆ ë° ì•ˆì •ì„± í–¥ìƒ")
    fi
    
    # ì»¤ë°‹ ë©”ì‹œì§€ êµ¬ì„±
    local commit_message="$commit_title

"
    
    for change in "${changes[@]}"; do
        commit_message+="- $change
"
    done
    
    commit_message+="
ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    # ì»¤ë°‹ ì‹¤í–‰
    execute_commit "$commit_message" "$vuln_type"
}

# ê¸°íƒ€ ì»¤ë°‹ ìœ í˜•ë“¤ (ê°„ë‹¨í•œ êµ¬í˜„)
handle_bugfix_commit() {
    read -p "ë²„ê·¸ ìˆ˜ì • ë‚´ìš©ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”: " bug_description
    local commit_msg="fix: $bug_description

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git add .
    execute_commit "$commit_msg" "bugfix"
}

handle_refactor_commit() {
    read -p "ë¦¬íŒ©í† ë§ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”: " refactor_description
    local commit_msg="refactor: $refactor_description

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git add .
    execute_commit "$commit_msg" "refactor"
}

handle_docs_commit() {
    local commit_msg="docs: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë° ê°œì„ 

- í”„ë¡œì íŠ¸ ë¬¸ì„œ ë‚´ìš© ë³´ê°•
- ì‚¬ìš©ë²• ë° ê°€ì´ë“œ ê°œì„ 

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git add .
    execute_commit "$commit_msg" "docs"
}

handle_test_commit() {
    local commit_msg="test: í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€ ë° ê°œì„ 

- í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ
- í…ŒìŠ¤íŠ¸ ì•ˆì •ì„± ê°œì„ 

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git add .
    execute_commit "$commit_msg" "test"
}

handle_other_commit() {
    read -p "ë³€ê²½ì‚¬í•­ì„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”: " change_description
    local commit_msg="chore: $change_description

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git add .
    execute_commit "$commit_msg" "other"
}

# ìë™ ì»¤ë°‹ (ì¸ìë¡œ ì·¨ì•½ì  íƒ€ì… ë°›ìŒ)
automatic_commit() {
    local vuln_type="$1"
    local korean_name="${VULN_KOREAN_NAMES[$vuln_type]:-$vuln_type}"
    
    show_commit_progress "[$vuln_type] ìë™ ì»¤ë°‹ ëª¨ë“œ"
    
    # ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
    git add .
    
    # ë³€ê²½ì‚¬í•­ í™•ì¸
    if git diff --cached --quiet; then
        show_commit_warning "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        return 0
    fi
    
    # ìë™ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
    generate_vulnerability_commit_message "$vuln_type" "$korean_name"
}

# ì‹¤ì œ ì»¤ë°‹ ì‹¤í–‰
execute_commit() {
    local commit_message="$1"
    local commit_type="$2"
    
    show_commit_progress "ì»¤ë°‹ ì‹¤í–‰ ì¤‘..."
    
    echo ""
    echo -e "${YELLOW}ì»¤ë°‹ ë©”ì‹œì§€:${NC}"
    echo "----------------------------------------"
    echo "$commit_message"
    echo "----------------------------------------"
    echo ""
    
    read -p "ì´ ë‚´ìš©ìœ¼ë¡œ ì»¤ë°‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        if git commit -m "$commit_message"; then
            show_commit_success "ì»¤ë°‹ ì™„ë£Œ!"
            log_commit "COMMIT_SUCCESS: $commit_type"
            
            # ìë™ í‘¸ì‹œ ì˜µì…˜
            echo ""
            read -p "ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " push_confirm
            
            if [[ "$push_confirm" =~ ^[Nn]$ ]]; then
                show_commit_warning "í‘¸ì‹œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            else
                show_commit_progress "ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ ì¤‘..."
                if git push; then
                    show_commit_success "í‘¸ì‹œ ì™„ë£Œ!"
                    log_commit "PUSH_SUCCESS: $commit_type"
                else
                    show_commit_error "í‘¸ì‹œ ì‹¤íŒ¨"
                    log_commit "PUSH_FAILED: $commit_type"
                fi
            fi
        else
            show_commit_error "ì»¤ë°‹ ì‹¤íŒ¨"
            log_commit "COMMIT_FAILED: $commit_type"
            exit 1
        fi
    else
        show_commit_warning "ì»¤ë°‹ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
        log_commit "COMMIT_CANCELLED: $commit_type"
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi