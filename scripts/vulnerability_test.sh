#!/bin/bash

# ==============================================
# S_WEB_Project ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ ìë™í™” ìŠ¤í¬ë¦½íŠ¸
# ==============================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_ROOT="/home/wsl/S_WEB_Project"
WEBSEC_LAB_DIR="$PROJECT_ROOT/websec-lab/src/webhacking"
TEST_LOG="$PROJECT_ROOT/log/test_results_$(date +%Y%m%d_%H%M%S).log"

# ë¡œê¹… í•¨ìˆ˜
log_test() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$TEST_LOG"
}

# ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜ë“¤
show_test_progress() {
    echo -e "${BLUE}ğŸ§ª $1${NC}"
    log_test "TEST_PROGRESS: $1"
}

show_test_success() {
    echo -e "${GREEN}âœ… $1${NC}"
    log_test "TEST_SUCCESS: $1"
}

show_test_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
    log_test "TEST_WARNING: $1"
}

show_test_error() {
    echo -e "${RED}âŒ $1${NC}"
    log_test "TEST_ERROR: $1"
}

# ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
main() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "ğŸ§ª S_WEB_Project ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ ìë™í™”"
    echo "=================================================="
    echo -e "${NC}"
    
    # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$(dirname "$TEST_LOG")"
    log_test "í…ŒìŠ¤íŠ¸ ì‹œì‘"
    
    # ì¸ìë¡œ ë°›ì€ ì·¨ì•½ì  íƒ€ì… í™•ì¸
    if [[ $# -eq 1 ]]; then
        test_specific_vulnerability "$1"
    else
        test_all_vulnerabilities
    fi
}

# íŠ¹ì • ì·¨ì•½ì  í…ŒìŠ¤íŠ¸
test_specific_vulnerability() {
    local vuln_type="$1"
    local test_file="$WEBSEC_LAB_DIR/${vuln_type}_test.php"
    
    show_test_progress "[$vuln_type] í…ŒìŠ¤íŠ¸ ì‹œì‘"
    
    if [[ ! -f "$test_file" ]]; then
        show_test_error "í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $test_file"
        return 1
    fi
    
    # PHP êµ¬ë¬¸ ê²€ì‚¬
    run_syntax_check "$test_file" "$vuln_type"
    
    # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    run_code_quality_check "$test_file" "$vuln_type"
    
    # ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬
    run_security_pattern_check "$test_file" "$vuln_type"
    
    # ì‹¤ì œ ì‹¤í–‰ í™•ì¸
    check_real_execution_implementation "$test_file" "$vuln_type"
    
    show_test_success "[$vuln_type] ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
}

# ì „ì²´ ì·¨ì•½ì  í…ŒìŠ¤íŠ¸
test_all_vulnerabilities() {
    show_test_progress "ì „ì²´ ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    
    local vulnerabilities=("xxe" "ssrf" "ssti" "open_redirect" "xpath")
    local failed_tests=()
    
    for vuln in "${vulnerabilities[@]}"; do
        echo ""
        if test_specific_vulnerability "$vuln"; then
            show_test_success "[$vuln] í…ŒìŠ¤íŠ¸ í†µê³¼"
        else
            show_test_error "[$vuln] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            failed_tests+=("$vuln")
        fi
    done
    
    # ê²°ê³¼ ìš”ì•½
    echo ""
    echo -e "${PURPLE}ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½${NC}"
    echo "=================================================="
    
    if [[ ${#failed_tests[@]} -eq 0 ]]; then
        show_test_success "ëª¨ë“  ì·¨ì•½ì  í…ŒìŠ¤íŠ¸ í†µê³¼!"
    else
        show_test_warning "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: ${failed_tests[*]}"
    fi
}

# PHP êµ¬ë¬¸ ê²€ì‚¬
run_syntax_check() {
    local file="$1"
    local vuln_type="$2"
    
    show_test_progress "[$vuln_type] PHP êµ¬ë¬¸ ê²€ì‚¬"
    
    if command -v php &> /dev/null; then
        if php -l "$file" &> /dev/null; then
            show_test_success "[$vuln_type] PHP êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼"
            return 0
        else
            show_test_error "[$vuln_type] PHP êµ¬ë¬¸ ì˜¤ë¥˜ ë°œê²¬"
            php -l "$file"
            return 1
        fi
    else
        show_test_warning "[$vuln_type] PHPê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ êµ¬ë¬¸ ê²€ì‚¬ ê±´ë„ˆëœ€"
        return 0
    fi
}

# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
run_code_quality_check() {
    local file="$1"
    local vuln_type="$2"
    
    show_test_progress "[$vuln_type] ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
    
    local issues=()
    
    # ê¸°ë³¸ì ì¸ íŒ¨í„´ ê²€ì‚¬
    if ! grep -q "<?php" "$file"; then
        issues+=("PHP ì˜¤í”„ë‹ íƒœê·¸ ëˆ„ë½")
    fi
    
    if ! grep -q "TestPage" "$file"; then
        issues+=("TestPage í´ë˜ìŠ¤ ì‚¬ìš© í™•ì¸ í•„ìš”")
    fi
    
    if ! grep -q "payloads" "$file"; then
        issues+=("í˜ì´ë¡œë“œ ì •ì˜ í™•ì¸ í•„ìš”")
    fi
    
    if ! grep -q "defense_methods\|ë°©ì–´\|ë³´ì•ˆ" "$file"; then
        issues+=("ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ ì„¹ì…˜ í™•ì¸ í•„ìš”")
    fi
    
    if [[ ${#issues[@]} -eq 0 ]]; then
        show_test_success "[$vuln_type] ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"
        return 0
    else
        show_test_warning "[$vuln_type] ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ:"
        for issue in "${issues[@]}"; do
            echo "    - $issue"
        done
        return 1
    fi
}

# ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬
run_security_pattern_check() {
    local file="$1"
    local vuln_type="$2"
    
    show_test_progress "[$vuln_type] ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬"
    
    local security_issues=()
    
    # ìœ„í—˜í•œ í•¨ìˆ˜ ì‚¬ìš© í™•ì¸
    if grep -q "eval\|exec\|system\|shell_exec" "$file"; then
        if ! grep -q "êµìœ¡\|í•™ìŠµ\|í…ŒìŠ¤íŠ¸" "$file"; then
            security_issues+=("ìœ„í—˜í•œ í•¨ìˆ˜ ì‚¬ìš© ì‹œ êµìœ¡ ëª©ì  ëª…ì‹œ í•„ìš”")
        fi
    fi
    
    # ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ í™•ì¸
    if grep -q "\$_GET\|\$_POST\|\$_REQUEST" "$file"; then
        if ! grep -q "htmlspecialchars\|filter_input\|validation" "$file"; then
            security_issues+=("ì‚¬ìš©ì ì…ë ¥ ê²€ì¦/ì´ìŠ¤ì¼€ì´í”„ í™•ì¸ í•„ìš”")
        fi
    fi
    
    if [[ ${#security_issues[@]} -eq 0 ]]; then
        show_test_success "[$vuln_type] ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬ í†µê³¼"
        return 0
    else
        show_test_warning "[$vuln_type] ë³´ì•ˆ íŒ¨í„´ ì´ìŠˆ:"
        for issue in "${security_issues[@]}"; do
            echo "    - $issue"
        done
        return 1
    fi
}

# ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„ í™•ì¸
check_real_execution_implementation() {
    local file="$1"
    local vuln_type="$2"
    
    show_test_progress "[$vuln_type] ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„ í™•ì¸"
    
    local implementation_score=0
    local max_score=4
    
    # 1. ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì œê±° í™•ì¸
    if ! grep -q "ì‹œë®¬ë ˆì´ì…˜\|simulation\|ê°€ìƒ\|fake" "$file"; then
        ((implementation_score++))
        log_test "[$vuln_type] âœ“ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì œê±°ë¨"
    else
        log_test "[$vuln_type] âœ— ì•„ì§ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ í¬í•¨"
    fi
    
    # 2. ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ í™•ì¸
    case "$vuln_type" in
        "xxe")
            if grep -q "file_get_contents\|simplexml_load_string\|DOMDocument" "$file"; then
                ((implementation_score++))
                log_test "[$vuln_type] âœ“ ì‹¤ì œ XML íŒŒì‹± ì½”ë“œ ì¡´ì¬"
            fi
            ;;
        "ssrf")
            if grep -q "curl\|file_get_contents.*http\|stream_context_create" "$file"; then
                ((implementation_score++))
                log_test "[$vuln_type] âœ“ ì‹¤ì œ HTTP ìš”ì²­ ì½”ë“œ ì¡´ì¬"
            fi
            ;;
        "ssti")
            if grep -q "Twig\|Smarty\|eval\|render" "$file"; then
                ((implementation_score++))
                log_test "[$vuln_type] âœ“ í…œí”Œë¦¿ ì—”ì§„ ì½”ë“œ ì¡´ì¬"
            fi
            ;;
    esac
    
    # 3. ê²°ê³¼ ë¹„êµ êµ¬í˜„ í™•ì¸
    if grep -q "vulnerable.*output\|safe.*comparison\|ì·¨ì•½í•œ.*ì•ˆì „í•œ" "$file"; then
        ((implementation_score++))
        log_test "[$vuln_type] âœ“ ì·¨ì•½í•œ vs ì•ˆì „í•œ êµ¬í˜„ ë¹„êµ ì¡´ì¬"
    fi
    
    # 4. ì»¬ëŸ¬ ì½”ë”© í™•ì¸
    if grep -q "class.*vulnerable\|class.*safe\|color.*red\|color.*green" "$file"; then
        ((implementation_score++))
        log_test "[$vuln_type] âœ“ ì»¬ëŸ¬ ì½”ë”© êµ¬í˜„ ì¡´ì¬"
    fi
    
    # ê²°ê³¼ í‰ê°€
    local percentage=$((implementation_score * 100 / max_score))
    
    if [[ $percentage -ge 75 ]]; then
        show_test_success "[$vuln_type] ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„ ì™„ë£Œë„: ${percentage}%"
        return 0
    elif [[ $percentage -ge 50 ]]; then
        show_test_warning "[$vuln_type] ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„ ì§„í–‰ ì¤‘: ${percentage}%"
        return 1
    else
        show_test_error "[$vuln_type] ì‹¤ì œ ì‹¤í–‰ êµ¬í˜„ í•„ìš”: ${percentage}%"
        return 1
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ í™•ì¸ ë° ì‹¤í–‰
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi